---
import Base from "../layouts/Base.astro";
import {
    fetchAllFragments,
    blobUrl,
    DID,
    fetchBskyPosts,
    fetchBskyFeed,
    parseBskyUrl,
} from "../lib/atproto";
import type { Fragment, BskyPost } from "../lib/types";

// Pinned bsky post URLs
const PINNED_BSKY_URLS = [
    "https://bsky.app/profile/nate.rip/post/3mcs53dio3c2s",
    "https://bsky.app/profile/nate.rip/post/3malzuto3x22s",
    "https://bsky.app/profile/nate.rip/post/3lxqjbta66k2k",
    "https://bsky.app/profile/nate.rip/post/3ltkowbdsuk2g",
    "https://bsky.app/profile/nate.rip/post/3ljqadka7qk2r",
    "https://bsky.app/profile/nate.rip/post/3ljixbqlta22z",
    "https://bsky.app/profile/nate.rip/post/3li2ujkthr22x",
    "https://bsky.app/profile/nate.rip/post/3lggjq25c6k2w",
    "https://bsky.app/profile/nate.rip/post/3lbulbyvexk2v",
    "https://bsky.app/profile/nate.rip/post/3ju4vkv7esa2p",
];

const pinnedRkeys = PINNED_BSKY_URLS.map((u) => parseBskyUrl(u)!).filter(
    Boolean,
);

// Fetch everything in parallel
const [fragments, pinnedPosts, feedPosts] = await Promise.all([
    fetchAllFragments(),
    fetchBskyPosts(pinnedRkeys),
    fetchBskyFeed(25, new Set(pinnedRkeys)),
]);

// Build a unified timeline: fragments + pinned bsky posts, sorted by date desc
type GridEntry =
    | { kind: "fragment"; f: Fragment }
    | { kind: "bsky"; p: BskyPost };

const allEntries: GridEntry[] = [
    ...fragments.map((f) => ({ kind: "fragment" as const, f })),
    ...pinnedPosts.map((p) => ({ kind: "bsky" as const, p })),
];
allEntries.sort((a, b) => {
    const da = new Date(
        a.kind === "fragment" ? a.f.createdAt : a.p.createdAt,
    ).getTime();
    const db = new Date(
        b.kind === "fragment" ? b.f.createdAt : b.p.createdAt,
    ).getTime();
    return db - da; // newest first
});

const hero = allEntries.find(
    (e) => e.kind === "fragment" && e.f.type === "shot" && e.f.images?.length,
);
const grid = allEntries.filter((e) => e !== hero);

const totalFragments = fragments.length;

function excerpt(text: string, len: number = 120): string {
    return text
        .replace(/[#*_\[\]()>`~\-]/g, "")
        .replace(/\n+/g, " ")
        .trim()
        .slice(0, len);
}

function extractListItems(content: string, max: number = 5): string[] {
    const items: string[] = [];
    for (const line of content.split("\n")) {
        if (items.length >= max) break;
        const h = line.match(/^##\s+(.+)/);
        if (h) {
            items.push(h[1].replace(/\*\*/g, ""));
            continue;
        }
        const b = line.match(/^[-*]\s+(.+)/);
        if (b && !line.startsWith("  ")) {
            items.push(
                b[1]
                    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
                    .replace(/\*\*/g, "")
                    .trim(),
            );
        }
    }
    return items;
}

function countListItems(content: string): number {
    return content.split("\n").filter((l) => l.match(/^(##\s|[-*]\s)/)).length;
}

const SHOT_VARIANTS = ["viewfinder", "evidence", "hud"] as const;
type ShotVariant = (typeof SHOT_VARIANTS)[number];

function shotMeta(
    i: number,
    imgCount: number,
): { cls: string; isHero: boolean; variant: ShotVariant } {
    const variant = SHOT_VARIANTS[i % 3];
    // Shots are visual — never 1x1, always at least 2-wide
    if (imgCount >= 3 && i % 6 === 0)
        return { cls: "tile-hero-wide", isHero: true, variant }; // 3x2 hero
    if (i % 7 === 0) return { cls: "tile-3w", isHero: false, variant }; // 3-wide
    if (i % 4 === 0) return { cls: "tile-w tile-t", isHero: false, variant }; // 2x2 feature
    return { cls: "tile-w", isHero: false, variant }; // default 2-wide
}

const POST_VARIANTS = ["cassette", "circuit", "blast"] as const;
type PostVariant = (typeof POST_VARIANTS)[number];

function postMeta(
    i: number,
    contentLen: number,
): { cls: string; showExcerpt: boolean; variant: PostVariant } {
    const variant = POST_VARIANTS[i % 3];
    // More variety — roughly half of posts get bigger treatment
    if (contentLen > 2000 && i % 4 === 0)
        return { cls: "tile-text-lg", showExcerpt: true, variant }; // 2-wide featured
    if (i % 7 === 0) return { cls: "tile-text-tall", showExcerpt: true, variant }; // tall with excerpt
    if (i % 3 === 0) return { cls: "tile-w", showExcerpt: true, variant }; // 2-wide with excerpt
    return { cls: "", showExcerpt: false, variant }; // 1x1
}

// Bsky tiles — visual-first, generous sizing
function bskySize(p: BskyPost, i: number): string {
    if (p.video) return "tile-bsky-hero"; // videos 3x2
    if (p.images && p.images.length >= 2) return "tile-bsky-hero"; // multi-image 3x2
    if (p.images?.length === 1)
        return i % 3 === 0 ? "tile-bsky-hero" : "tile-w"; // single image: some hero, rest 2-wide
    if (p.hasMedia) return "tile-w"; // link thumb 2-wide
    return ""; // text-only 1x1
}

// Build render sequence with log + feed injected
type RenderItem =
    | { kind: "log" }
    | { kind: "feed" }
    | { kind: "entry"; e: GridEntry; i: number };

const renderItems: RenderItem[] = [];
grid.forEach((e, i) => {
    if (i === 5) renderItems.push({ kind: "log" });
    if (i === 12) renderItems.push({ kind: "feed" });
    renderItems.push({ kind: "entry", e, i });
});
if (grid.length <= 5) renderItems.push({ kind: "log" });
if (grid.length <= 12) renderItems.push({ kind: "feed" });

// Format relative time for bsky posts
function relTime(iso: string): string {
    const d = new Date(iso);
    const now = Date.now();
    const diff = now - d.getTime();
    const days = Math.floor(diff / 86400000);
    if (days < 1) return "today";
    if (days < 30) return `${days}d ago`;
    if (days < 365) return `${Math.floor(days / 30)}mo ago`;
    return d.toISOString().slice(0, 10);
}
---

<Base wide>
    <section class="mosaic">
        <header class="tile tile-header">
            <h1>nate.rip</h1>
            <span class="header-count">{totalFragments}</span>
            <nav class="header-filters">
                <button class="filter-btn active" data-filter="post"
                    >{fragments.filter((f) => f.type === "post").length} posts</button
                >
                <button class="filter-btn active" data-filter="shot"
                    >{fragments.filter((f) => f.type === "shot").length} shots</button
                >
                <button class="filter-btn active" data-filter="list"
                    >{fragments.filter((f) => f.type === "list").length} lists</button
                >
                <button class="filter-btn active" data-filter="link"
                    >{fragments.filter((f) => f.type === "link").length} links</button
                >
                <button class="filter-btn active" data-filter="bsky"
                    >{pinnedPosts.length} bsky</button
                >
            </nav>
        </header>

        {
            hero && hero.kind === "fragment" && hero.f.images && (
                <a
                    href={`/f/${hero.f.id}`}
                    class="tile tile-shot tile-hero"
                    data-type="shot"
                >
                    <img
                        src={blobUrl(DID, hero.f.images[0].cid)}
                        alt={hero.f.title}
                    />
                    <div class="hero-scanlines" />
                    <div class="hero-corners">
                        <>
                            <i class="hc hc-tl" />
                            <i class="hc hc-tr" />
                        </>
                        <>
                            <i class="hc hc-bl" />
                            <i class="hc hc-br" />
                        </>
                    </div>
                    <div class="hero-info">
                        <span class="hero-tag type-shot">
                            shot #{hero.f.id}
                        </span>
                        <h2>{hero.f.title}</h2>
                    </div>
                </a>
            )
        }

        {
            renderItems.map((item) => {
                // Log tile — tactical data terminal
                if (item.kind === "log") {
                    return (
                        <nav class="tile tile-log">
                            <div class="log-chrome-top">
                                <div class="log-rivets">
                                    <>
                                        <i />
                                        <i />
                                        <i />
                                        <i />
                                    </>
                                </div>
                                <div class="log-label">log</div>
                                <span class="log-count">
                                    {allEntries.length}
                                </span>
                            </div>
                            <div class="log-body">
                                <div class="log-screen">
                                    <div class="log-entries">
                                        {allEntries.map((e) => {
                                            if (e.kind === "fragment") {
                                                return (
                                                    <a
                                                        href={`/f/${e.f.id}`}
                                                        class="log-row"
                                                    >
                                                        <span class="log-id">
                                                            {String(
                                                                e.f.id,
                                                            ).padStart(2, "0")}
                                                        </span>
                                                        <span
                                                            class={`log-type type-${e.f.type}`}
                                                        >
                                                            {e.f.type}
                                                        </span>
                                                        <span class="log-title">
                                                            {e.f.title}
                                                        </span>
                                                        <time class="log-date">
                                                            {new Date(
                                                                e.f.createdAt,
                                                            )
                                                                .toISOString()
                                                                .slice(0, 10)}
                                                        </time>
                                                    </a>
                                                );
                                            }
                                            return (
                                                <a
                                                    href={`https://bsky.app/profile/${e.p.author.handle}/post/${e.p.rkey}`}
                                                    class="log-row"
                                                    target="_blank"
                                                >
                                                    <span class="log-id log-bsky">
                                                        bs
                                                    </span>
                                                    <span class="log-type type-bsky">
                                                        bsky
                                                    </span>
                                                    <span class="log-title">
                                                        {e.p.text.slice(0, 60)}
                                                    </span>
                                                    <time class="log-date">
                                                        {new Date(e.p.createdAt)
                                                            .toISOString()
                                                            .slice(0, 10)}
                                                    </time>
                                                </a>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                            <div class="log-chrome-bottom">
                                <div class="log-ticks">
                                    <>
                                        <i />
                                        <i />
                                        <i />
                                        <i />
                                        <i />
                                        <i />
                                        <i />
                                        <i />
                                    </>
                                </div>
                            </div>
                        </nav>
                    );
                }

                // Feed tile — comms terminal with CRT effect
                if (item.kind === "feed") {
                    return (
                        <div class="tile tile-feed" data-type="bsky">
                            <div class="feed-bezel">
                                <div class="feed-header">
                                    <span class="feed-icon">@</span>
                                    <span class="feed-label">
                                        nate.rip on bsky
                                    </span>
                                    <div class="feed-signal">
                                        <>
                                            <i />
                                            <i />
                                            <i />
                                        </>
                                    </div>
                                </div>
                                <div class="feed-screen">
                                    <div class="feed-crt" />
                                    <div class="feed-vignette" />
                                    <div class="feed-entries">
                                        {feedPosts.slice(0, 15).map((p) => (
                                            <a
                                                href={`https://bsky.app/profile/${p.author.handle}/post/${p.rkey}`}
                                                class="feed-row"
                                                target="_blank"
                                            >
                                                <div class="feed-text">
                                                    {p.text.length > 120
                                                        ? p.text.slice(0, 120) +
                                                          "..."
                                                        : p.text}
                                                </div>
                                                <div class="feed-meta">
                                                    <time>
                                                        {relTime(p.createdAt)}
                                                    </time>
                                                    {p.isRepost && (
                                                        <span class="feed-repost">
                                                            repost
                                                        </span>
                                                    )}
                                                    {p.images?.length ? (
                                                        <span class="feed-stat">
                                                            {p.images.length}{" "}
                                                            img
                                                        </span>
                                                    ) : null}
                                                </div>
                                            </a>
                                        ))}
                                    </div>
                                </div>
                                <div class="feed-statusbar">
                                    <span>{feedPosts.length} posts</span>
                                    <span class="feed-pulse" />
                                </div>
                            </div>
                        </div>
                    );
                }

                // Grid entries
                const { e, i } = item;

                // Bsky pinned post tile — signal packet style
                if (e.kind === "bsky") {
                    const p = e.p;
                    const sizeCls = bskySize(p, i);
                    const bskyUrl = `https://bsky.app/profile/${p.author.handle}/post/${p.rkey}`;
                    const hasMedia = !!(p.video || p.images?.length || p.externalEmbed?.thumb);

                    const mediaSrc = p.video
                        ? null
                        : p.images?.[0]?.fullsize
                          ?? p.externalEmbed?.thumb
                          ?? null;

                    const mediaAlt = p.images?.[0]?.alt ?? p.externalEmbed?.title ?? "";
                    const textLen = p.text.length;

                    // Media packet — header + media + overlay
                    if (hasMedia) {
                        return (
                            <a
                                href={bskyUrl}
                                class:list={["tile", "tile-bsky", sizeCls]}
                                data-type="bsky"
                                target="_blank"
                            >
                                <div class="bsky-header">
                                    <span class="bsky-field"><em>SRC</em> nate.rip</span>
                                    <span class="bsky-field"><em>TS</em> {relTime(p.createdAt)}</span>
                                </div>
                                <div class="bsky-media">
                                    {p.video ? (
                                        <video
                                            src={p.video.playlist}
                                            poster={p.video.thumbnail}
                                            autoplay
                                            muted
                                            loop
                                            playsinline
                                        />
                                    ) : (
                                        <img
                                            src={mediaSrc!}
                                            alt={mediaAlt}
                                            loading="lazy"
                                        />
                                    )}
                                    <div class="bsky-overlay">
                                        <p class="bsky-text">
                                            {p.text.length > 80
                                                ? p.text.slice(0, 80) + "..."
                                                : p.text}
                                        </p>
                                    </div>
                                </div>
                            </a>
                        );
                    }

                    // Text-only packet — header + body + checksum
                    return (
                        <a
                            href={bskyUrl}
                            class:list={["tile", "tile-bsky", sizeCls]}
                            data-type="bsky"
                            target="_blank"
                        >
                            <div class="bsky-header">
                                <span class="bsky-field"><em>SRC</em> nate.rip</span>
                                <span class="bsky-field"><em>TS</em> {relTime(p.createdAt)}</span>
                                <span class="bsky-field"><em>LEN</em> {textLen}</span>
                            </div>
                            <div class="bsky-body">
                                <p class="bsky-text">
                                    {p.text.length > 180
                                        ? p.text.slice(0, 180) + "..."
                                        : p.text}
                                </p>
                            </div>
                            <div class="bsky-checksum">
                                {p.likeCount > 0 ? `0x${p.likeCount.toString(16).padStart(2, '0')} likes` : ''}
                                {p.likeCount > 0 && p.replyCount > 0 ? ' \u2022 ' : ''}
                                {p.replyCount > 0 ? `0x${p.replyCount.toString(16).padStart(2, '0')} rpl` : ''}
                            </div>
                        </a>
                    );
                }

                // Fragment entries (same as before)
                const f = e.f;
                const isShot = f.type === "shot" && f.images?.length;
                const isList = f.type === "list";

                if (isShot) {
                    const { cls, isHero: promoted, variant } = shotMeta(
                        i,
                        f.images!.length,
                    );
                    if (promoted) {
                        return (
                            <a
                                href={`/f/${f.id}`}
                                class:list={["tile", "tile-shot", cls]}
                                data-type="shot"
                            >
                                <img
                                    src={blobUrl(DID, f.images![0].cid)}
                                    alt={f.title}
                                    loading="lazy"
                                />
                                <div class="hero-scanlines" />
                                <div class="hero-corners">
                                    <>
                                        <i class="hc hc-tl" />
                                        <i class="hc hc-tr" />
                                    </>
                                    <>
                                        <i class="hc hc-bl" />
                                        <i class="hc hc-br" />
                                    </>
                                </div>
                                <div class="hero-info">
                                    <span class="hero-tag type-shot">
                                        shot #{f.id}
                                    </span>
                                    <h2>{f.title}</h2>
                                </div>
                            </a>
                        );
                    }

                    // Viewfinder variant — crosshairs + ticks + exposure
                    if (variant === "viewfinder") {
                        return (
                            <a
                                href={`/f/${f.id}`}
                                class:list={["tile", "tile-shot", "shot-viewfinder", cls]}
                                data-type="shot"
                            >
                                <img
                                    src={blobUrl(DID, f.images![0].cid)}
                                    alt={f.title}
                                    loading="lazy"
                                />
                                <span class="shot-exposure">f/{f.id} &bull; {new Date(f.createdAt).toISOString().slice(0, 10)}</span>
                                <div class="shot-ticks" />
                            </a>
                        );
                    }

                    // Evidence variant — film holder notches + marker badge
                    if (variant === "evidence") {
                        return (
                            <a
                                href={`/f/${f.id}`}
                                class:list={["tile", "tile-shot", "shot-evidence", cls]}
                                data-type="shot"
                            >
                                <img
                                    src={blobUrl(DID, f.images![0].cid)}
                                    alt={f.title}
                                    loading="lazy"
                                />
                                <div class="shot-marker">{f.id}</div>
                            </a>
                        );
                    }

                    // HUD variant — broken corner frame + scan line + data overlay
                    return (
                        <a
                            href={`/f/${f.id}`}
                            class:list={["tile", "tile-shot", "shot-hud", cls]}
                            data-type="shot"
                        >
                            <img
                                src={blobUrl(DID, f.images![0].cid)}
                                alt={f.title}
                                loading="lazy"
                            />
                            <div class="shot-data">REC<br/>{String(f.id).padStart(3, "0")}</div>
                        </a>
                    );
                }

                if (isList) {
                    const items = extractListItems(f.content ?? "");
                    const total = countListItems(f.content ?? "");
                    return (
                        <a
                            href={`/f/${f.id}`}
                            class="tile tile-list"
                            data-type="list"
                        >
                            <div class="list-head">
                                <span class="list-tag">list</span>
                                <h3>{f.title}</h3>
                            </div>
                            <div class="list-rule" />
                            <ul class="list-items">
                                {items.map((li) => (
                                    <li>{li}</li>
                                ))}
                            </ul>
                            <div class="list-foot">
                                {total > items.length && (
                                    <span class="list-more">
                                        +{total - items.length} more
                                    </span>
                                )}
                                <time>
                                    {new Date(f.createdAt)
                                        .toISOString()
                                        .slice(0, 10)}
                                </time>
                            </div>
                        </a>
                    );
                }

                // Links — relay card: intercepted transmission from elsewhere
                if (f.type === "link" && f.url) {
                    const domain = new URL(f.url).hostname.replace(
                        /^www\./,
                        "",
                    );
                    return (
                        <a
                            href={f.url}
                            class="tile tile-link"
                            data-type="link"
                            target="_blank"
                        >
                            <div class="link-chrome">
                                <span class="link-signal">↗</span>
                                <span class="link-relay">relay</span>
                                <span class="link-freq">{domain}</span>
                            </div>
                            <div class="link-body">
                                <h3>{f.title}</h3>
                                {f.content && (
                                    <p class="link-comment">{f.content}</p>
                                )}
                            </div>
                            <div class="link-chrome-bottom">
                                <time>
                                    {new Date(f.createdAt)
                                        .toISOString()
                                        .slice(0, 10)}
                                </time>
                                <div class="link-connectors">
                                    <i /><i /><i />
                                </div>
                            </div>
                        </a>
                    );
                }

                // Posts — alternate circuit board / blast door
                const { cls, showExcerpt, variant: postVariant } = postMeta(
                    i,
                    f.content?.length ?? 0,
                );

                if (postVariant === "cassette") {
                    return (
                        <a
                            href={`/f/${f.id}`}
                            class:list={["tile", "tile-post", "post-cassette", cls]}
                            data-type="post"
                        >
                            <span class="post-catalog">NR-{String(f.id).padStart(2, "0")}</span>
                            <div class="post-label">
                                <span class="post-type">post</span>
                                <h3>{f.title}</h3>
                                {showExcerpt && f.content && (
                                    <p class="post-excerpt">{excerpt(f.content, 140)}</p>
                                )}
                            </div>
                            <div class="post-footer">
                                <span class="post-type">post</span>
                                <time>{new Date(f.createdAt).toISOString().slice(0, 10)}</time>
                            </div>
                            <div class="post-edge" />
                        </a>
                    );
                }

                if (postVariant === "circuit") {
                    return (
                        <a
                            href={`/f/${f.id}`}
                            class:list={["tile", "tile-post", "post-circuit", cls]}
                            data-type="post"
                        >
                            <div class="post-chip">
                                <span class="post-part">IC-{String(f.id).padStart(2, "0")}</span>
                                <span class="post-type">post</span>
                                <h3>{f.title}</h3>
                                {showExcerpt && f.content && (
                                    <p class="post-excerpt">{excerpt(f.content, 160)}</p>
                                )}
                                <time>{new Date(f.createdAt).toISOString().slice(0, 10)}</time>
                            </div>
                        </a>
                    );
                }

                // Blast door
                return (
                    <a
                        href={`/f/${f.id}`}
                        class:list={["tile", "tile-post", "post-blast", cls]}
                        data-type="post"
                    >
                        <div class="post-rail">
                            <div class="post-hex" />
                            <div class="post-hex" />
                            <span class="post-rail-label">Post</span>
                            <div class="post-hex" />
                        </div>
                        <div class="post-body">
                            <h3>{f.title}</h3>
                            {showExcerpt && f.content && (
                                <p class="post-excerpt">{excerpt(f.content, 160)}</p>
                            )}
                            <time>{new Date(f.createdAt).toISOString().slice(0, 10)}</time>
                        </div>
                        <div class="post-stripe" />
                    </a>
                );
            })
        }
    </section>
</Base>

<script>
    document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
            btn.classList.toggle("active");
            const active = new Set(
                [...document.querySelectorAll(".filter-btn.active")].map(
                    (b) => (b as HTMLElement).dataset.filter,
                ),
            );
            document
                .querySelectorAll<HTMLElement>("[data-type]")
                .forEach((tile) => {
                    tile.style.display = active.has(tile.dataset.type)
                        ? ""
                        : "none";
                });
        });
    });
</script>
